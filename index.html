<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC Live Stream Client</title>

<style>
body {
    font-family: georgia;
    background: linear-gradient(to right, teal, maroon);
    border: 1px solid orange;
    border-radius: 4px;
    margin-top: 1px;
    color: orange;
    text-align: center;
    padding: 2px;
}

footer, h1 {
    border: 1px solid orange;
    border-radius: 4px;
    background: teal;
    margin: 2px;
    padding: 10px;
    color: orange;
}

h2 {
    border: 1px solid orange;
    border-radius: 6px;
    background: maroon;
    margin: 20px;
    font-size: 14px;
    padding: 8px;
    color: orange;
    text-align: center;
}

.container { max-width: 1100px; margin: auto; }
header { margin-bottom: 20px; }
.grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }

.card {
    background: linear-gradient(to right, maroon, teal);
    padding: 2px;
    border-radius: 14px;
    box-shadow: 0px 4px 14px rgba(0,0,0,0.2);
    color: black;
    text-align: left;
    border:1px solid orange;
}

.video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; }
.video-feed { width: 100%; height: 100%; background-color: #1f2937; border-radius: 10px; object-fit: cover; transform: scaleX(-1); }
#remoteVideo { transform: scaleX(1); }

button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; }
.btn-green { background: teal; color: orange; }
.btn-red { background: maroon; color: orange; }
.btn-blue { background: orange; color: gray; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

.flex-row { display: flex; gap: 10px; margin-top: 15px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }

#remoteStatus { position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 10px; color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; }

#statusConsole {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 12px;
    height: 140px;
    overflow-y: scroll;
    font-size: 14px;
    border: 1px solid orange;
    color: teal;
}

.login-screen input[type="text"] { width: 90%; padding: 6px; margin-top: 6px; border-radius: 6px; border:1px solid orange; }
.login-screen input[type="file"] { margin-top:6px; }
.previewPic { width:60px;height:60px;border-radius:50%;display:none;margin-top:6px; }

#broadcasterList img { width:30px;height:30px;border-radius:50%;vertical-align:middle;margin-right:5px; }

#localPlaceholder { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:10px; display:none; }
</style>
</head>

<body>
<div class="container">

<header>
<h1>Full Stack Live Stream</h1>

<div id="loginScreen" class="login-screen">
    <h2>Welcome</h2>

    <label>Your Name</label>
    <input type="text" id="usernameInput" placeholder="Enter your name">

    <label>Profile Picture</label>
    <input type="file" id="profilePicInput" accept="image/*">

    <img id="previewPic" class="previewPic"><br><br>

    <button id="saveProfileBtn">Save & Continue</button>
</div>

<p id="userIdDisplay" style="color:white;">Your ID: Connecting...</p>
<p id="broadcasterStatus" style="color:yellow;">Status: Waiting for Broadcaster.</p>
<p style="font-size:12px; margin-top:5px; color:lightcoral;">Note: P2P simulated connections.</p>
</header>

<div class="grid">

    <!-- LOCAL STREAM -->
    <div class="card">
        <h2>Your Camera</h2>
        <div class="video-container">
            <video id="localVideo" class="video-feed" autoplay playsinline muted></video>
            <img id="localPlaceholder" src="">
        </div>

        <div class="flex-row">
            <button id="startStreamBtn" onclick="startLocalStream(true)" class="btn-green">
                <span id="startText">Start Broadcast</span>
            </button>
            <button id="stopStreamBtn" onclick="stopLocalStream()" class="btn-red" disabled>Stop Broadcast</button>
        </div>

        <div class="flex-between" style="margin-top:15px;">
            <label>
                <input type="checkbox" id="frontCameraToggle" checked>
                <span style="margin-left:5px;">Use Front Camera</span>
            </label>

            <button id="connectBtn" onclick="requestConnectAsViewer()" class="btn-blue" disabled>
                Connect as Viewer
            </button>
        </div>

        <button id="changeProfileBtn" class="btn-blue" style="margin-top:10px; display:none;">
            Change Profile / Logout
        </button>
    </div>

    <!-- REMOTE STREAM -->
    <div class="card">
        <h2>Remote Broadcast Feed</h2>
        <div class="video-container">
            <video id="remoteVideo" class="video-feed" autoplay playsinline></video>
            <p id="remoteStatus">Awaiting Stream...</p>
        </div>
    </div>

</div><br>

<button onclick="toggleBroadcasterList()">Show Broadcasters ▼</button>
<div id="broadcasterList" style="display:none; background:white; color:black; padding:10px; margin:10px; border-radius:6px; border:1px solid orange;">
    Loading…
</div>

<div class="card" style="margin-top:20px;">
    <h3 style="margin-bottom:10px; text-align:center; color:teal;">System Console</h3>
    <div id="statusConsole"></div>
</div>

</div>
<footer style="font-size:10px;">&copy; 2025 Copyright SM Technology Live Streaming</footer>

<script>
const WS_URL = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host;
let ws = null;
let pc = null;
let localStream = null;
let userId = null;
let username = null;
let profilePic = null;
let activeBroadcasterId = null;
let activeBroadcasterName = null;
let isBroadcasting = false;

const localVideo = document.getElementById("localVideo");
const localPlaceholder = document.getElementById("localPlaceholder");
const remoteVideo = document.getElementById("remoteVideo");
const remoteStatus = document.getElementById("remoteStatus");
const consoleEl = document.getElementById("statusConsole");

const startBtn = document.getElementById("startStreamBtn");
const stopBtn = document.getElementById("stopStreamBtn");
const connectBtn = document.getElementById("connectBtn");
const cameraToggle = document.getElementById("frontCameraToggle");
const userIdDisplay = document.getElementById("userIdDisplay");
const broadcasterStatus = document.getElementById("broadcasterStatus");

const broadcasterListEl = document.getElementById("broadcasterList");
const changeProfileBtn = document.getElementById("changeProfileBtn");
let broadcasterDropdownVisible = false;

const PEER_CONFIG = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function log(msg) {
    const p = document.createElement("p");
    p.textContent = msg;
    consoleEl.appendChild(p);
    consoleEl.scrollTop = consoleEl.scrollHeight;
}

// ---------------- LOGIN & PROFILE ----------------
window.onload = () => {
    const savedName = localStorage.getItem("username");
    const savedPic = localStorage.getItem("profilePic");

    if (savedName && savedPic) {
        username = savedName;
        profilePic = savedPic;
        document.getElementById("loginScreen").style.display = "none";

        localVideo.style.display = "none";
        localPlaceholder.src = profilePic;
        localPlaceholder.style.display = "block";

        sendProfileToServer();
        changeProfileBtn.style.display = "inline-block";
    }
};

document.getElementById("profilePicInput").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById("previewPic").src = e.target.result;
        document.getElementById("previewPic").style.display = "block";
    };
    reader.readAsDataURL(file);
});

document.getElementById("saveProfileBtn").addEventListener("click", () => {
    const nameInput = document.getElementById("usernameInput").value.trim();
    const picSrc = document.getElementById("previewPic").src;

    if (!nameInput) { alert("Enter your name"); return; }
    if (!picSrc) { alert("Upload a picture"); return; }

    username = nameInput;
    profilePic = picSrc;

    localStorage.setItem("username", username);
    localStorage.setItem("profilePic", profilePic);

    document.getElementById("loginScreen").style.display = "none";

    localVideo.style.display = "none";
    localPlaceholder.src = profilePic;
    localPlaceholder.style.display = "block";

    sendProfileToServer();
    changeProfileBtn.style.display = "inline-block";
});

// Change Profile / Logout button
changeProfileBtn.addEventListener("click", () => {
    stopLocalStream();
    localStorage.removeItem("username");
    localStorage.removeItem("profilePic");
    username = null;
    profilePic = null;

    localVideo.style.display = "none";
    localPlaceholder.src = "";
    localPlaceholder.style.display = "none";

    document.getElementById("loginScreen").style.display = "block";
    changeProfileBtn.style.display = "none";

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "logout" }));
    }
});

function sendProfileToServer() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "setProfile", username, profilePic }));
    }
}

// ---------------- BROADCASTER DROPDOWN ----------------
function toggleBroadcasterList() {
    broadcasterDropdownVisible = !broadcasterDropdownVisible;
    broadcasterListEl.style.display = broadcasterDropdownVisible ? "block" : "none";
}

// Update broadcaster list with profile pictures and clickable selection
function updateBroadcasterDropdown(list) {
    broadcasterListEl.innerHTML = "<h4>Available Broadcasters:</h4>";
    if (!list || list.length === 0) {
        broadcasterListEl.innerHTML += "<p>No broadcasters online.</p>";
        return;
    }

    list.forEach(b => {
        const entry = document.createElement("div");
        entry.style.cursor = "pointer";
        entry.style.display = "flex";
        entry.style.alignItems = "center";
        entry.style.gap = "8px";
        entry.style.marginBottom = "4px";

        const img = document.createElement("img");
        img.src = b.pic || "";
        img.alt = b.name;
        img.style.width = "30px";
        img.style.height = "30px";
        img.style.borderRadius = "50%";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = b.name;

        entry.appendChild(img);
        entry.appendChild(nameSpan);

        entry.addEventListener("click", () => {
            activeBroadcasterId = b.id;
            activeBroadcasterName = b.name;
            connectBtn.disabled = false;
            broadcasterStatus.textContent = "Selected Broadcaster: " + b.name;
            broadcasterListEl.style.display = "none";
            broadcasterDropdownVisible = false;
        });

        broadcasterListEl.appendChild(entry);
    });
}

// ---------------- WEBSOCKET ----------------
function connectSignalingServer() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => {
        log("Connected to server");
        sendProfileToServer();
    };

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        switch (data.type) {
            case "broadcaster_list":
                updateBroadcasterDropdown(data);
                break;
            case "broadcaster_started":
                broadcasterStatus.textContent = "Broadcaster Online: " + data.broadcasterName;
                updateBroadcasterDropdown(data.list || []);
                connectBtn.disabled = false;
                break;
            case "broadcaster_ended":
                broadcasterStatus.textContent = "No active broadcaster.";
                connectBtn.disabled = true;
                remoteVideo.srcObject = null;
                remoteStatus.textContent = "Awaiting Stream...";
                updateBroadcasterDropdown(data.list || []);
                break;

            case "offer":
                startLocalStream(false).then(() => createAnswer(data.sdp, data.from));
                break;
            case "answer":
                pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                break;
            case "candidate":
                if (pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                break;
        }
    };

    ws.onclose = () => setTimeout(connectSignalingServer, 1500);
}
connectSignalingServer();

// ---------------- WEBRTC LOGIC ----------------
async function startLocalStream(isBroadcaster = false) {
    startBtn.disabled = true;
    stopBtn.disabled = false;

    const constraints = { video: { facingMode: cameraToggle.checked ? "user" : "environment" }, audio: true };

    try {
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        localVideo.style.display = "block";
        localPlaceholder.style.display = "none";
    } catch (err) {
        console.warn("Camera not available, showing profile picture.");
        localVideo.style.display = "none";
        localPlaceholder.src = profilePic || "";
        localPlaceholder.style.display = "block";
    }

    isBroadcasting = isBroadcaster;
    if (isBroadcasting) {
        ws.send(JSON.stringify({ type: "start_broadcast", name: username }));
        broadcasterStatus.textContent = "YOU ARE BROADCASTING";
    }

    initPeerConnection();
}

function stopLocalStream() {
    stopBtn.disabled = true;
    startBtn.disabled = false;

    if (localStream) localStream.getTracks().forEach(t => t.stop());
    localStream = null;

    if (isBroadcasting) ws.send(JSON.stringify({ type: "stop_broadcast" }));

    stopPeerConnection();

    localVideo.style.display = "none";
    localPlaceholder.src = profilePic || "";
    localPlaceholder.style.display = "block";

    remoteVideo.srcObject = null;
    remoteStatus.textContent = "Awaiting Stream...";

    isBroadcasting = false;
}

function initPeerConnection() {
    pc = new RTCPeerConnection(PEER_CONFIG);
    if (localStream) localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; remoteStatus.textContent = ""; };
    pc.onicecandidate = (event) => {
        if (event.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate, to: pc.targetId }));
    };
}

function stopPeerConnection() { if (pc) pc.close(); pc = null; }

async function createOffer(viewerId) {
    pc.targetId = viewerId;
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: "offer", sdp: offer, to: viewerId }));
}

async function createAnswer(offer, broadcasterId) {
    pc.targetId = broadcasterId;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type: "answer", sdp: answer, to: broadcasterId }));
}

function requestConnectAsViewer() {
    if (activeBroadcasterId) ws.send(JSON.stringify({ type: "request_offer", viewerId: userId, to: activeBroadcasterId }));
}
</script>
</body>
</html>